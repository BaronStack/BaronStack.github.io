{"title":"C++面试问题准备：i++是否原子操作，为什么","slug":"C-面试问题准备：i-是否原子操作，为什么","date":"2018-02-17T06:48:38.000Z","updated":"2018-02-22T12:54:00.000Z","comments":true,"path":"api/articles/C-面试问题准备：i-是否原子操作，为什么.json","photos":[],"link":"","excerpt":"什么是操作系统原子操作原子操作是不可分割的，在执行完毕之前不会被任何其他事物或者事件中断，分为以下两种情况：在单线程中， 能够在单条指令中完成的操作都可以认为是” 原子操作”，因为中断只能发生于指令之间在多线程中，不能被其它进程（线程）打断的操作就叫原子操作","covers":null,"content":"<h2 id=\"什么是操作系统原子操作\"><a href=\"#什么是操作系统原子操作\" class=\"headerlink\" title=\"什么是操作系统原子操作\"></a>什么是操作系统原子操作</h2><p><strong>原子操作是不可分割的，在执行完毕之前不会被任何其他事物或者事件中断，分为以下两种情况：</strong></p>\n<ul>\n<li>在单线程中， 能够在单条指令中完成的操作都可以认为是” 原子操作”，因为中断只能发生于指令之间</li>\n<li>在多线程中，不能被其它进程（线程）打断的操作就叫原子操作 <a id=\"more\"></a></li>\n</ul>\n<h2 id=\"i-分为三个阶段\"><a href=\"#i-分为三个阶段\" class=\"headerlink\" title=\"i++分为三个阶段\"></a>i++分为三个阶段</h2><ol>\n<li>内存到寄存器</li>\n<li>寄存器自增</li>\n<li>写回内存</li>\n</ol>\n<p>一般的编译器会将i++翻译为</p>\n<figure class=\"highlight x86asm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">mov</span> <span class=\"built_in\">eax</span>,  <span class=\"built_in\">dword</span> <span class=\"built_in\">ptr</span>[i]</span><br><span class=\"line\"><span class=\"keyword\">inc</span> <span class=\"built_in\">eax</span></span><br><span class=\"line\"><span class=\"keyword\">mov</span> <span class=\"built_in\">dword</span> <span class=\"built_in\">ptr</span>[i], <span class=\"built_in\">eax</span></span><br></pre></td></tr></table></figure>\n<p>但是在没有加锁的情况下不会产生互斥，所以这样肯定不是原子操作。除非编译器能够将第一第二步操作翻译为<code>lock inc dword ptr[i]</code>，那么该锁会锁住总线，从而保证无论多核还是单核CPU都只会自增一次。</p>\n<blockquote>\n<p>所以针对问题<strong>i++在两个线程里边分别执行100次，能得到的最大值和最小值分别是多少？</strong>的答案便是2-200<br>当两个线程每次执行完++之后不写入内存，最后一个较小的线程将值写入内存为2；相反，当两个线程每次读入寄存器并执行完操作之后都写入内存，且线程交叉执行，最后的结果就是200</p>\n</blockquote>\n","categories":[{"name":"面试","slug":"面试","count":13,"path":"api/categories/面试.json"}],"tags":[{"name":"C++","slug":"C","count":11,"path":"api/tags/C.json"}]}